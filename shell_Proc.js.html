<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>shell/Proc.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="perf.PerfData.html">PerfData</a><ul class='methods'><li data-type='method'><a href="perf.PerfData.html#end">end</a></li><li data-type='method'><a href="perf.PerfData.html#lap">lap</a></li><li data-type='method'><a href="perf.PerfData.html#report">report</a></li></ul></li><li><a href="shell.Proc.html">Proc</a><ul class='methods'><li data-type='method'><a href="shell.Proc.html#dir">dir</a></li><li data-type='method'><a href="shell.Proc.html#do">do</a></li><li data-type='method'><a href="shell.Proc.html#env">env</a></li><li data-type='method'><a href="shell.Proc.html#pipe">pipe</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-errno.html">errno</a><ul class='members'><li data-type='member'><a href="module-errno.html#.E2BIG">E2BIG</a></li><li data-type='member'><a href="module-errno.html#.EACCES">EACCES</a></li><li data-type='member'><a href="module-errno.html#.EAGAIN">EAGAIN</a></li><li data-type='member'><a href="module-errno.html#.EBADF">EBADF</a></li><li data-type='member'><a href="module-errno.html#.EBUSY">EBUSY</a></li><li data-type='member'><a href="module-errno.html#.ECHILD">ECHILD</a></li><li data-type='member'><a href="module-errno.html#.EDOM">EDOM</a></li><li data-type='member'><a href="module-errno.html#.EEXIST">EEXIST</a></li><li data-type='member'><a href="module-errno.html#.EFAULT">EFAULT</a></li><li data-type='member'><a href="module-errno.html#.EFBIG">EFBIG</a></li><li data-type='member'><a href="module-errno.html#.EINTR">EINTR</a></li><li data-type='member'><a href="module-errno.html#.EINVAL">EINVAL</a></li><li data-type='member'><a href="module-errno.html#.EIO">EIO</a></li><li data-type='member'><a href="module-errno.html#.EISDIR">EISDIR</a></li><li data-type='member'><a href="module-errno.html#.EMFILE">EMFILE</a></li><li data-type='member'><a href="module-errno.html#.EMLINK">EMLINK</a></li><li data-type='member'><a href="module-errno.html#.ENFILE">ENFILE</a></li><li data-type='member'><a href="module-errno.html#.ENODEV">ENODEV</a></li><li data-type='member'><a href="module-errno.html#.ENOENT">ENOENT</a></li><li data-type='member'><a href="module-errno.html#.ENOEXEC">ENOEXEC</a></li><li data-type='member'><a href="module-errno.html#.ENOMEM">ENOMEM</a></li><li data-type='member'><a href="module-errno.html#.ENOSPC">ENOSPC</a></li><li data-type='member'><a href="module-errno.html#.ENOTBLK">ENOTBLK</a></li><li data-type='member'><a href="module-errno.html#.ENOTDIR">ENOTDIR</a></li><li data-type='member'><a href="module-errno.html#.ENOTTY">ENOTTY</a></li><li data-type='member'><a href="module-errno.html#.ENXIO">ENXIO</a></li><li data-type='member'><a href="module-errno.html#.EPERM">EPERM</a></li><li data-type='member'><a href="module-errno.html#.EPIPE">EPIPE</a></li><li data-type='member'><a href="module-errno.html#.ERANGE">ERANGE</a></li><li data-type='member'><a href="module-errno.html#.EROFS">EROFS</a></li><li data-type='member'><a href="module-errno.html#.ESPIPE">ESPIPE</a></li><li data-type='member'><a href="module-errno.html#.ESRCH">ESRCH</a></li><li data-type='member'><a href="module-errno.html#.ETXTBSY">ETXTBSY</a></li><li data-type='member'><a href="module-errno.html#.EXDEV">EXDEV</a></li></ul><ul class='methods'><li data-type='method'><a href="module-errno.html#.fail">fail</a></li></ul></li><li><a href="module-fs.html">fs</a><ul class='members'><li data-type='member'><a href="module-fs.html#.S_IFBLK">S_IFBLK</a></li><li data-type='member'><a href="module-fs.html#.S_IFCHR">S_IFCHR</a></li><li data-type='member'><a href="module-fs.html#.S_IFDIR">S_IFDIR</a></li><li data-type='member'><a href="module-fs.html#.S_IFIFO">S_IFIFO</a></li><li data-type='member'><a href="module-fs.html#.S_IFLNK">S_IFLNK</a></li><li data-type='member'><a href="module-fs.html#.S_IFMT">S_IFMT</a></li><li data-type='member'><a href="module-fs.html#.S_IFREG">S_IFREG</a></li><li data-type='member'><a href="module-fs.html#.S_IFSOC">S_IFSOC</a></li></ul><ul class='methods'><li data-type='method'><a href="module-fs.html#.basename">basename</a></li><li data-type='method'><a href="module-fs.html#.copy_file">copy_file</a></li><li data-type='method'><a href="module-fs.html#.create_temp_file">create_temp_file</a></li><li data-type='method'><a href="module-fs.html#.dirname">dirname</a></li><li data-type='method'><a href="module-fs.html#.exists">exists</a></li><li data-type='method'><a href="module-fs.html#.is_block_device">is_block_device</a></li><li data-type='method'><a href="module-fs.html#.is_char_device">is_char_device</a></li><li data-type='method'><a href="module-fs.html#.is_directory">is_directory</a></li><li data-type='method'><a href="module-fs.html#.is_executable">is_executable</a></li><li data-type='method'><a href="module-fs.html#.is_fifo">is_fifo</a></li><li data-type='method'><a href="module-fs.html#.is_file">is_file</a></li><li data-type='method'><a href="module-fs.html#.is_link">is_link</a></li><li data-type='method'><a href="module-fs.html#.is_readable">is_readable</a></li><li data-type='method'><a href="module-fs.html#.is_socket">is_socket</a></li><li data-type='method'><a href="module-fs.html#.is_writable">is_writable</a></li><li data-type='method'><a href="module-fs.html#.list_dir">list_dir</a></li><li data-type='method'><a href="module-fs.html#.mkdir">mkdir</a></li><li data-type='method'><a href="module-fs.html#.mkdirp">mkdirp</a></li><li data-type='method'><a href="module-fs.html#.mkfifo">mkfifo</a></li><li data-type='method'><a href="module-fs.html#.normalize_path">normalize_path</a></li><li data-type='method'><a href="module-fs.html#.read_file">read_file</a></li><li data-type='method'><a href="module-fs.html#.read_link">read_link</a></li><li data-type='method'><a href="module-fs.html#.realpath">realpath</a></li><li data-type='method'><a href="module-fs.html#.rmdir">rmdir</a></li><li data-type='method'><a href="module-fs.html#.stat">stat</a></li><li data-type='method'><a href="module-fs.html#.unlink">unlink</a></li><li data-type='method'><a href="module-fs.html#.write_file">write_file</a></li></ul></li><li><a href="module-io.html">io</a><ul class='members'><li data-type='member'><a href="module-io.html#.POLLERR">POLLERR</a></li><li data-type='member'><a href="module-io.html#.POLLHUP">POLLHUP</a></li><li data-type='member'><a href="module-io.html#.POLLIN">POLLIN</a></li><li data-type='member'><a href="module-io.html#.POLLMSG">POLLMSG</a></li><li data-type='member'><a href="module-io.html#.POLLNVAL">POLLNVAL</a></li><li data-type='member'><a href="module-io.html#.POLLOUT">POLLOUT</a></li><li data-type='member'><a href="module-io.html#.POLLPRI">POLLPRI</a></li><li data-type='member'><a href="module-io.html#.POLLRDBAND">POLLRDBAND</a></li><li data-type='member'><a href="module-io.html#.POLLRDHUP">POLLRDHUP</a></li><li data-type='member'><a href="module-io.html#.POLLRDNORM">POLLRDNORM</a></li><li data-type='member'><a href="module-io.html#.POLLREMOVE">POLLREMOVE</a></li><li data-type='member'><a href="module-io.html#.POLLWRBAND">POLLWRBAND</a></li><li data-type='member'><a href="module-io.html#.POLLWRNORM">POLLWRNORM</a></li><li data-type='member'><a href="module-io.html#.SEEK_CUR">SEEK_CUR</a></li><li data-type='member'><a href="module-io.html#.SEEK_END">SEEK_END</a></li><li data-type='member'><a href="module-io.html#.SEEK_SET">SEEK_SET</a></li></ul><ul class='methods'><li data-type='method'><a href="module-io.html#.append">append</a></li><li data-type='method'><a href="module-io.html#.close">close</a></li><li data-type='method'><a href="module-io.html#.create">create</a></li><li data-type='method'><a href="module-io.html#.dup">dup</a></li><li data-type='method'><a href="module-io.html#.dup2">dup2</a></li><li data-type='method'><a href="module-io.html#.open">open</a></li><li data-type='method'><a href="module-io.html#.pipe">pipe</a></li><li data-type='method'><a href="module-io.html#.poll">poll</a></li><li data-type='method'><a href="module-io.html#.read">read</a></li><li data-type='method'><a href="module-io.html#.read_fully">read_fully</a></li><li data-type='method'><a href="module-io.html#.read_string">read_string</a></li><li data-type='method'><a href="module-io.html#.seek">seek</a></li><li data-type='method'><a href="module-io.html#.tell">tell</a></li><li data-type='method'><a href="module-io.html#.truncate">truncate</a></li><li data-type='method'><a href="module-io.html#.write">write</a></li><li data-type='method'><a href="module-io.html#.write_string">write_string</a></li></ul></li><li><a href="module-kern.html">kern</a><ul class='members'><li data-type='member'><a href="module-kern.html#.printk">printk</a></li><li data-type='member'><a href="module-kern.html#.search_path">search_path</a></li><li data-type='member'><a href="module-kern.html#.version">version</a></li></ul></li><li><a href="module-math.html">math</a><ul class='methods'><li data-type='method'><a href="module-math.html#.get_random_bytes">get_random_bytes</a></li></ul></li><li><a href="module-perf.html">perf</a><ul class='methods'><li data-type='method'><a href="module-perf.html#.start">start</a></li></ul></li><li><a href="module-proc.html">proc</a><ul class='members'><li data-type='member'><a href="module-proc.html#.SIGABRT">SIGABRT</a></li><li data-type='member'><a href="module-proc.html#.SIGALRM">SIGALRM</a></li><li data-type='member'><a href="module-proc.html#.SIGBUS">SIGBUS</a></li><li data-type='member'><a href="module-proc.html#.SIGCHLD">SIGCHLD</a></li><li data-type='member'><a href="module-proc.html#.SIGCONT">SIGCONT</a></li><li data-type='member'><a href="module-proc.html#.SIGFPE">SIGFPE</a></li><li data-type='member'><a href="module-proc.html#.SIGHUP">SIGHUP</a></li><li data-type='member'><a href="module-proc.html#.SIGILL">SIGILL</a></li><li data-type='member'><a href="module-proc.html#.SIGINT">SIGINT</a></li><li data-type='member'><a href="module-proc.html#.SIGIO">SIGIO</a></li><li data-type='member'><a href="module-proc.html#.SIGIOT">SIGIOT</a></li><li data-type='member'><a href="module-proc.html#.SIGKILL">SIGKILL</a></li><li data-type='member'><a href="module-proc.html#.SIGPIPE">SIGPIPE</a></li><li data-type='member'><a href="module-proc.html#.SIGPOLL">SIGPOLL</a></li><li data-type='member'><a href="module-proc.html#.SIGPROF">SIGPROF</a></li><li data-type='member'><a href="module-proc.html#.SIGPWR">SIGPWR</a></li><li data-type='member'><a href="module-proc.html#.SIGQUIT">SIGQUIT</a></li><li data-type='member'><a href="module-proc.html#.SIGSEGV">SIGSEGV</a></li><li data-type='member'><a href="module-proc.html#.SIGSTKFLT">SIGSTKFLT</a></li><li data-type='member'><a href="module-proc.html#.SIGSTOP">SIGSTOP</a></li><li data-type='member'><a href="module-proc.html#.SIGSYS">SIGSYS</a></li><li data-type='member'><a href="module-proc.html#.SIGTERM">SIGTERM</a></li><li data-type='member'><a href="module-proc.html#.SIGTRAP">SIGTRAP</a></li><li data-type='member'><a href="module-proc.html#.SIGTSTP">SIGTSTP</a></li><li data-type='member'><a href="module-proc.html#.SIGTTIN">SIGTTIN</a></li><li data-type='member'><a href="module-proc.html#.SIGTTOU">SIGTTOU</a></li><li data-type='member'><a href="module-proc.html#.SIGUNUSED">SIGUNUSED</a></li><li data-type='member'><a href="module-proc.html#.SIGURG">SIGURG</a></li><li data-type='member'><a href="module-proc.html#.SIGUSR1">SIGUSR1</a></li><li data-type='member'><a href="module-proc.html#.SIGUSR2">SIGUSR2</a></li><li data-type='member'><a href="module-proc.html#.SIGVTALRM">SIGVTALRM</a></li><li data-type='member'><a href="module-proc.html#.SIGWINCH">SIGWINCH</a></li><li data-type='member'><a href="module-proc.html#.SIGXCPU">SIGXCPU</a></li><li data-type='member'><a href="module-proc.html#.SIGXFSZ">SIGXFSZ</a></li><li data-type='member'><a href="module-proc.html#.WCONTINUED">WCONTINUED</a></li><li data-type='member'><a href="module-proc.html#.WNOHANG">WNOHANG</a></li><li data-type='member'><a href="module-proc.html#.WUNTRACED">WUNTRACED</a></li></ul><ul class='methods'><li data-type='method'><a href="module-proc.html#.alarm">alarm</a></li><li data-type='method'><a href="module-proc.html#.atexit">atexit</a></li><li data-type='method'><a href="module-proc.html#.chdir">chdir</a></li><li data-type='method'><a href="module-proc.html#.exec">exec</a></li><li data-type='method'><a href="module-proc.html#.exit">exit</a></li><li data-type='method'><a href="module-proc.html#.fork">fork</a></li><li data-type='method'><a href="module-proc.html#.fork2">fork2</a></li><li data-type='method'><a href="module-proc.html#.getegid">getegid</a></li><li data-type='method'><a href="module-proc.html#.getenv">getenv</a></li><li data-type='method'><a href="module-proc.html#.geteuid">geteuid</a></li><li data-type='method'><a href="module-proc.html#.getgid">getgid</a></li><li data-type='method'><a href="module-proc.html#.getpid">getpid</a></li><li data-type='method'><a href="module-proc.html#.getuid">getuid</a></li><li data-type='method'><a href="module-proc.html#.kill">kill</a></li><li data-type='method'><a href="module-proc.html#.setenv">setenv</a></li><li data-type='method'><a href="module-proc.html#.setsid">setsid</a></li><li data-type='method'><a href="module-proc.html#.signal">signal</a></li><li data-type='method'><a href="module-proc.html#.sleep">sleep</a></li><li data-type='method'><a href="module-proc.html#.unsetenv">unsetenv</a></li><li data-type='method'><a href="module-proc.html#.waitpid">waitpid</a></li></ul></li><li><a href="module-shell.html">shell</a><ul class='methods'><li data-type='method'><a href="module-shell.html#.$">$</a></li><li data-type='method'><a href="module-shell.html#.capture">capture</a></li><li data-type='method'><a href="module-shell.html#.file">file</a></li><li data-type='method'><a href="module-shell.html#.here">here</a></li><li data-type='method'><a href="module-shell.html#.search_path">search_path</a></li></ul></li><li><a href="module-stream.html">stream</a><ul class='methods'><li data-type='method'><a href="module-stream.html#.create">create</a></li><li data-type='method'><a href="module-stream.html#.read_line">read_line</a></li><li data-type='method'><a href="module-stream.html#.read_until">read_until</a></li></ul></li><li><a href="module-term.html">term</a><ul class='methods'><li data-type='method'><a href="module-term.html#.bg">bg</a></li><li data-type='method'><a href="module-term.html#.clear">clear</a></li><li data-type='method'><a href="module-term.html#.fg">fg</a></li><li data-type='method'><a href="module-term.html#.hide_cursor">hide_cursor</a></li><li data-type='method'><a href="module-term.html#.move_to">move_to</a></li><li data-type='method'><a href="module-term.html#.print">print</a></li><li data-type='method'><a href="module-term.html#.print2">print2</a></li><li data-type='method'><a href="module-term.html#.println">println</a></li><li data-type='method'><a href="module-term.html#.println2">println2</a></li><li data-type='method'><a href="module-term.html#.read_line">read_line</a></li><li data-type='method'><a href="module-term.html#.reset">reset</a></li><li data-type='method'><a href="module-term.html#.show_cursor">show_cursor</a></li><li data-type='method'><a href="module-term.html#.to_string">to_string</a></li></ul></li></ul><h3>Interfaces</h3><ul><li><a href="Redirection.html">Redirection</a><ul class='methods'><li data-type='method'><a href="Redirection.html#close">close</a></li><li data-type='method'><a href="Redirection.html#open">open</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#ListDirCallback">ListDirCallback</a></li><li><a href="global.html#Pollfd">Pollfd</a></li><li><a href="global.html#ProcExecOptions">ProcExecOptions</a></li><li><a href="global.html#ProcResult">ProcResult</a></li><li><a href="global.html#StatBuf">StatBuf</a></li><li><a href="global.html#SysError">SysError</a></li><li><a href="global.html#TimeSpec">TimeSpec</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">shell/Proc.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const io = require('io');
const proc = require('proc');
const term = require('term');

const println = term.println;
const println2 = term.println2;

/**
 * Interface for generic objects implementing redirections (other than Proc).
 *
 * @interface
 */
function Redirection() {}

Redirection.prototype = {
	/**
	 * Open fd associated to this redirection
	 *
	 * @returns {number}
	 * @throws {SysError}
	 */
	open: function(sourceFd) {
		throw new Error('Not implemented!');
	},

	/**
	 * Close fds associated to this redirection
	 *
	 * @returns {void}
	 * @throws {SysError}
	 */
	close: function() {
		throw new Error('Not implemented!');
	},
}

/**
 * @class
 * @hideconstructor
 * @memberof shell
 */
function Proc($, argv) {
	this.$ = $;
	this.is_a = 'Proc';
	this.argv = argv;

	this._dir = undefined;
	this._env = {};

	// Pipe is initial configuration
	this._pipe = {};

	// Redir is actual fd wiring
	this._redir = {};
}

Proc.prototype = {

	/**
	 * Set working directory for process
	 *
	 * @param {string} dir Path to a directory
	 * @returns {shell.Proc} 
	 * The same object where it is being invoked (for chaining)
	 */
	dir: function(dir) {
		this._dir = dir;
		return this;
	},

	/**
	 * Set environment variables for process
	 *
	 * @param {object} vars
	 * A hash of key value pairs. 
	 *
	 * Note that a null value unsets the variable.
	 *
	 * @returns {shell.Proc} 
	 * The same object where it is being invoked (for chaining)
	 */
	env: function(vars) {
		this._env = vars;
		return this;
	},

	/**
	 * Run a complete execution graph and wait for it to finish.
	 *
	 * @returns {ProcResult} The result of waiting for the last (deepest) child
	 * @see {module:proc.waitpid}
	 * @throws {SysError}
	 */
	do: function() {
		// Get Procs
		const childProcs = [this].concat(this._collectChildProcs());

		// Check if commands can be found
		for (var i = 0; i &lt; childProcs.length; i++) {
			const childProc = childProcs[i];

			if (this.$.search_path(childProc.argv[0]) === null) {
				throw new Error('Command not found: ' + childProc.argv[0]);
			}
		}

		// Store open fds
		const openFds = [];

		try {
			// Setup redirections
			for (var i = 0; i &lt; childProcs.length; i++) {
				openFds = openFds.concat(childProcs[i]._setupRedirections());
			}

			// Launch the Procs
			for (var i = 0; i &lt; childProcs.length; i++) {
				const childProc = childProcs[i];

				childProc._launch(function() {
					// Setup redirections storing used fds
					const fds = Object.keys(childProc._redir);
					const usedFds = {};

					for (var i = 0; i &lt; fds.length; i++) {
						const fd = fds[i];
						const fdTo = childProc._redir[fd];

						io.dup2(fdTo, fd);
						io.close(fdTo);

						usedFds[fdTo] = true;
					}

					// Close inherited fds not used by this child
					for (var i = 0; i &lt; openFds.length; i++) {
						const fd = openFds[i];

						if (!usedFds[fd]) {
							io.close(fd);
						}
					}
				});
			}

			// Wait for parent Procs to finish and get result from last child
			const last = childProcs.length - 1;

			for (var i = 0; i &lt; last; i++) {
				childProcs[i].wait();
			}

			const result = childProcs[last].wait();

			// Close redirections after execution
			const redirections = this._collectRedirections();
			for (var i = 0; i &lt; redirections.length; i++) {
				redirections[i].close();
			}

			return result;
		} 
		finally {
			// Close open fds (in case anything goes wrong)
			for (var i = 0; i &lt; openFds.length; i++) {
				io.close(openFds[i], false);
			}
		}
	},

	/**
	 * Redirect a process file descriptor to a capture 
	 * {@link module:shell.capture}, file {@link module:shell.file}, here 
	 * string {@link module:shell.here}, or another process
	 * {@link module:shell.$}.
	 *
	 * @param {number|number[]} [fds=[1]] 
	 * Process' file descriptors to pipe to the capture, file, here string or 
	 * process.
	 *
	 * Note that, in the case of capture or processes, only output file 
	 * descriptors make sense.
	 *
	 * In the case of here string, only input file descriptors make sense.
	 *
	 * @param {object|Proc|number|string|string[]|null} where
	 * Polymorphic parameter to express where to pipe to. Depending on the type
	 * it can be:
	 *
	 * -Proc: redirects output of this process to the other process. Valid
	 *  source `fds` are 1 (stdout) and 2 (stderr).
	 *
	 * -Opaque return from {@link module:shell.capture}: redirects output of 
	 *  this process to an object variable. Valid fds are 1 and 2 which store to 
	 *  properties `out` and `error`.
	 *
	 * -Opaque return from {@link module:shell.file}: redirects input/output
	 *  from/to a file. All fds are valid.
	 *
	 * -Opaque return from {@link module:shell.here}: redirects input from a 
	 *  string variable. Only fd 0 (stdin) is valid.
	 *
	 * -number: the source fds are redirected to the given fd
	 *
	 * -{}: if an empty object is given it is wrapped with 
	 *  {@link module:shell.capture}
	 *
	 * -string: the string is wrapped with {@link module:shell.file} with 
	 *  default open mode. If a custom open mode is desired, the file can be 
	 *  prefixed with the mode plus a colon (for example: '+:/tmp/my-file' 
	 *  appends to '/tmp/my-file', '0:out.log' truncates, and so on).
	 *
	 * -string[]: the one and only string inside the array is wrapped with 
	 *  {@link module:shell.here()}
	 *
	 * -null: same as `$.file('/dev/null')`
	 *
	 * @returns {shell.Proc} 
	 * The same object where it is being invoked (for chaining)
	 *
	 *  @throws {SysError}
	 */
	pipe: function(fds, where) {
		const $ = this.$;

		// Normalize arguments
		if (where === undefined) {
			where = fds;
			fds = [1];
		}
		if (!Array.isArray(fds)) {
			fds = [fds];
		}

		// Handle aliased behaviors (except null)
		if (where === null) {
			// do nothing
		}
		else if (typeof where === 'string') {
			if (where.startsWith('0:')) {
				where = $.file(where.substring(2), '0');
			}
			else if (where.startsWith('+:')) {
				where = $.file(where.substring(2), '+');
			}
			else if (where.startsWith(':')) {
				where = $.file(where.substring(1), '');
			}
			else {
				where = $.file(where);
			}
		}

		// TODO: this is a mess, generalize it for every openable case and single/multi fds
		// /dev/null
		if (where === null ) {
			for (var i = 0; i &lt; fds.length; i++) {
				this._pipe[fds[i]] = $.file('/dev/null');
			}
		}
		// capure: $.capture
		else if (where.is_a === 'Capture') {
			for (var i = 0; i &lt; fds.length; i++) {
				this._pipe[fds[i]] = where;
			}
		}
		// capture: {}
		else if (typeof where === 'object' &amp;&amp; Object.keys(where).length === 0) {
			where = $.capture(where);

			for (var i = 0; i &lt; fds.length; i++) {
				this._pipe[fds[i]] = where;
			}
		}
		// herestring: ['']
		else if (Array.isArray(where) &amp;&amp; typeof where[0] === 'string') {
			for (var i = 0; i &lt; fds.length; i++) {
				this._pipe[fds[i]] = $.here(where[0]);
			}
		}
		// Proc: $(...)
		else if (where.is_a === 'Proc') {
			// Redirect first fd to where
			this._pipe[fds[0]] = where;

			// Redirect rest of fds to first fd
			for (var i = 1; i &lt; fds.length; i++) {
				this._pipe[fds[i]] = fds[0];
			}
		}
		// EphemeralFd: $.file, $.here, ...
		else if (where.is_a === 'EphemeralFd') {
			for (var i = 0; i &lt; fds.length; i++) {
				this._pipe[fds[i]] = where;
			}
		}
		// another fd
		else if (typeof where === 'number') {
			for (var i = 0; i &lt; fds.length; i++) {
				this._pipe[fds[i]] = where;
			}
		}
		else {
			throw new Error('Unsupported redirection target: ' + where);
		}

		return this;
	},

	/**
	 * Return a string representation of the object
	 *
	 * @returns {string}
	 * @ignore
	 */
	toString: function() {
		return 'Proc{' + 
			'"' + this.argv.join(' ') + '"' +
			(this.pid 
				? (', pid: ' + this.pid)
				: '') +
			'}';
	},

	/**
	 * Wait for process to finish and get its exit status
	 *
	 * @return {ProcResult} The wait process result 
	 * @throws {SysError}
	 * @private
	 */
	wait: function() {
		return proc.waitpid(this.pid);
	},

	/**
	 * Collect all child Proc objects (excluding the one invoking the method).
	 *
	 * @returns {shell.Proc[]}
	 * @private
	 */
	_collectChildProcs: function() {
		const childProcs = [];

		const fds = Object.keys(this._pipe);

		for (var i = 0; i &lt; fds.length; i++) {
			const fd = fds[i];
			const where = this._pipe[fd];

			if (where.is_a === 'Proc') {
				childProcs.push(where);
				childProcs = childProcs.concat(where._collectChildProcs());
			}
		}

		return childProcs;
	},

	/**
	 * Recursively collect all redirection target objects (i.e. Capture, 
	 * EphemeralFd, ...)
	 *
	 * @returns {Redirection[]} 
	 * @private
	 */
	_collectRedirections: function() {
		const closeables = [];

		const fds = Object.keys(this._pipe);

		for (var i = 0; i &lt; fds.length; i++) {
			const fd = fds[i];
			const where = this._pipe[fd];

			if (typeof where.close === 'function') {
				if (!closeables.includes(where)) {
					closeables.push(where);
				}
			}
			else if (where.is_a === 'Proc' ) {
				// Recurse into child processes
				closeables = closeables.concat(where._collectRedirections());
			}
		}

		return closeables;
	},

	/**
	 * Setup redirections collecting all fds and objects in this._pipe and 
	 * putting their associated fds in this._redir.
	 *
	 * Note that any object in this._pipe other than Proc that implements 
	 * the {@link Redirection} interface (f.e. Capture and EphemeralFd) is handled 
	 * generically. 
	 *
	 * @returns {number[]} 
	 * An array containing all file descriptors that have been open as a 
	 * consequence of redirections.
	 *
	 * @throws {SysError}
	 * @private
	 */
	_setupRedirections: function() {
		const openFds = [];

		try {
			const fds = Object.keys(this._pipe);

			for (var i = 0; i &lt; fds.length; i++) {
				const fd = fds[i];
				const where = this._pipe[fd];

				if (where.is_a === 'Proc') {
					if (where._pipe[0]) {
						throw new Error(
							'Proc ' + where + ' stdin is redirected to both ' +
							where._pipe[0] + ' and ' + this
						);
					}

					const pipe = io.pipe();

					this._redir[fd] = pipe[1];
					openFds.push(this._redir[fd]);

					where._redir[0] = pipe[0];
					openFds.push(where._redir[0]);
				} else if (typeof where.open === 'function') {
					this._redir[fd] = where.open(fd);
					openFds.push(this._redir[fd]);
				} else if (typeof where === 'number') {
					this._redir[fd] = where;
				} else {
					throw new Error(
						'Unsupported redirection for fd ' + fd + ' of ' + 
						this + ': ' + where
					); 
				}
			}
		} 
		catch(err) {
			// Don't leak open fds
			for (var i = 0; i &lt; openFds.length; i++) {
				io.close(openFds[i], false);
			}

			throw err;
		}

		return openFds;
	},

	/**
	 * Launch the process without waiting for it (only this process, not the
	 * children)
	 *
	 * @param {function} [setupCB]
	 * A function invoked just before exec to setup the child process for
	 * execution. It doesn't receive parameters or return anything.
	 *
	 * @returns {Proc} The Proc where it is being invoked
	 * @throws {SysError}
	 * @private
	 */
	_launch: function(setupCB) {
		const self = this;

		const pid = proc.fork(function() {
			if (setupCB) {
				setupCB();
			}

			if (self._dir) {
				proc.chdir(self._dir);
			}

			proc.exec(self.argv[0], self.argv.slice(1), self._env);
		});

		// Store child pid in root process
		this.pid = pid;

		return this;
	},
}

return Proc;
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.6</a> on Mon Mar 22 2021 20:13:40 GMT+0100 (GMT+01:00) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>



</body>
</html>
