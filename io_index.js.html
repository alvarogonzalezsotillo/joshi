<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>io/index.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="perf.PerfData.html">PerfData</a><ul class='methods'><li data-type='method'><a href="perf.PerfData.html#end">end</a></li><li data-type='method'><a href="perf.PerfData.html#lap">lap</a></li><li data-type='method'><a href="perf.PerfData.html#report">report</a></li></ul></li><li><a href="shell.Proc.html">Proc</a><ul class='methods'><li data-type='method'><a href="shell.Proc.html#dir">dir</a></li><li data-type='method'><a href="shell.Proc.html#do">do</a></li><li data-type='method'><a href="shell.Proc.html#env">env</a></li><li data-type='method'><a href="shell.Proc.html#pipe">pipe</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-errno.html">errno</a><ul class='members'><li data-type='member'><a href="module-errno.html#.E2BIG">E2BIG</a></li><li data-type='member'><a href="module-errno.html#.EACCES">EACCES</a></li><li data-type='member'><a href="module-errno.html#.EAGAIN">EAGAIN</a></li><li data-type='member'><a href="module-errno.html#.EBADF">EBADF</a></li><li data-type='member'><a href="module-errno.html#.EBUSY">EBUSY</a></li><li data-type='member'><a href="module-errno.html#.ECHILD">ECHILD</a></li><li data-type='member'><a href="module-errno.html#.EDOM">EDOM</a></li><li data-type='member'><a href="module-errno.html#.EEXIST">EEXIST</a></li><li data-type='member'><a href="module-errno.html#.EFAULT">EFAULT</a></li><li data-type='member'><a href="module-errno.html#.EFBIG">EFBIG</a></li><li data-type='member'><a href="module-errno.html#.EINTR">EINTR</a></li><li data-type='member'><a href="module-errno.html#.EINVAL">EINVAL</a></li><li data-type='member'><a href="module-errno.html#.EIO">EIO</a></li><li data-type='member'><a href="module-errno.html#.EISDIR">EISDIR</a></li><li data-type='member'><a href="module-errno.html#.EMFILE">EMFILE</a></li><li data-type='member'><a href="module-errno.html#.EMLINK">EMLINK</a></li><li data-type='member'><a href="module-errno.html#.ENFILE">ENFILE</a></li><li data-type='member'><a href="module-errno.html#.ENODEV">ENODEV</a></li><li data-type='member'><a href="module-errno.html#.ENOENT">ENOENT</a></li><li data-type='member'><a href="module-errno.html#.ENOEXEC">ENOEXEC</a></li><li data-type='member'><a href="module-errno.html#.ENOMEM">ENOMEM</a></li><li data-type='member'><a href="module-errno.html#.ENOSPC">ENOSPC</a></li><li data-type='member'><a href="module-errno.html#.ENOTBLK">ENOTBLK</a></li><li data-type='member'><a href="module-errno.html#.ENOTDIR">ENOTDIR</a></li><li data-type='member'><a href="module-errno.html#.ENOTTY">ENOTTY</a></li><li data-type='member'><a href="module-errno.html#.ENXIO">ENXIO</a></li><li data-type='member'><a href="module-errno.html#.EPERM">EPERM</a></li><li data-type='member'><a href="module-errno.html#.EPIPE">EPIPE</a></li><li data-type='member'><a href="module-errno.html#.ERANGE">ERANGE</a></li><li data-type='member'><a href="module-errno.html#.EROFS">EROFS</a></li><li data-type='member'><a href="module-errno.html#.ESPIPE">ESPIPE</a></li><li data-type='member'><a href="module-errno.html#.ESRCH">ESRCH</a></li><li data-type='member'><a href="module-errno.html#.ETXTBSY">ETXTBSY</a></li><li data-type='member'><a href="module-errno.html#.EXDEV">EXDEV</a></li></ul><ul class='methods'><li data-type='method'><a href="module-errno.html#.fail">fail</a></li></ul></li><li><a href="module-fs.html">fs</a><ul class='members'><li data-type='member'><a href="module-fs.html#.S_IFBLK">S_IFBLK</a></li><li data-type='member'><a href="module-fs.html#.S_IFCHR">S_IFCHR</a></li><li data-type='member'><a href="module-fs.html#.S_IFDIR">S_IFDIR</a></li><li data-type='member'><a href="module-fs.html#.S_IFIFO">S_IFIFO</a></li><li data-type='member'><a href="module-fs.html#.S_IFLNK">S_IFLNK</a></li><li data-type='member'><a href="module-fs.html#.S_IFMT">S_IFMT</a></li><li data-type='member'><a href="module-fs.html#.S_IFREG">S_IFREG</a></li><li data-type='member'><a href="module-fs.html#.S_IFSOC">S_IFSOC</a></li></ul><ul class='methods'><li data-type='method'><a href="module-fs.html#.basename">basename</a></li><li data-type='method'><a href="module-fs.html#.copy_file">copy_file</a></li><li data-type='method'><a href="module-fs.html#.create_temp_file">create_temp_file</a></li><li data-type='method'><a href="module-fs.html#.dirname">dirname</a></li><li data-type='method'><a href="module-fs.html#.exists">exists</a></li><li data-type='method'><a href="module-fs.html#.is_block_device">is_block_device</a></li><li data-type='method'><a href="module-fs.html#.is_char_device">is_char_device</a></li><li data-type='method'><a href="module-fs.html#.is_directory">is_directory</a></li><li data-type='method'><a href="module-fs.html#.is_executable">is_executable</a></li><li data-type='method'><a href="module-fs.html#.is_fifo">is_fifo</a></li><li data-type='method'><a href="module-fs.html#.is_file">is_file</a></li><li data-type='method'><a href="module-fs.html#.is_link">is_link</a></li><li data-type='method'><a href="module-fs.html#.is_readable">is_readable</a></li><li data-type='method'><a href="module-fs.html#.is_socket">is_socket</a></li><li data-type='method'><a href="module-fs.html#.is_writable">is_writable</a></li><li data-type='method'><a href="module-fs.html#.list_dir">list_dir</a></li><li data-type='method'><a href="module-fs.html#.mkdir">mkdir</a></li><li data-type='method'><a href="module-fs.html#.mkdirp">mkdirp</a></li><li data-type='method'><a href="module-fs.html#.mkfifo">mkfifo</a></li><li data-type='method'><a href="module-fs.html#.normalize_path">normalize_path</a></li><li data-type='method'><a href="module-fs.html#.read_file">read_file</a></li><li data-type='method'><a href="module-fs.html#.read_link">read_link</a></li><li data-type='method'><a href="module-fs.html#.realpath">realpath</a></li><li data-type='method'><a href="module-fs.html#.rmdir">rmdir</a></li><li data-type='method'><a href="module-fs.html#.stat">stat</a></li><li data-type='method'><a href="module-fs.html#.unlink">unlink</a></li><li data-type='method'><a href="module-fs.html#.write_file">write_file</a></li></ul></li><li><a href="module-io.html">io</a><ul class='members'><li data-type='member'><a href="module-io.html#.POLLERR">POLLERR</a></li><li data-type='member'><a href="module-io.html#.POLLHUP">POLLHUP</a></li><li data-type='member'><a href="module-io.html#.POLLIN">POLLIN</a></li><li data-type='member'><a href="module-io.html#.POLLMSG">POLLMSG</a></li><li data-type='member'><a href="module-io.html#.POLLNVAL">POLLNVAL</a></li><li data-type='member'><a href="module-io.html#.POLLOUT">POLLOUT</a></li><li data-type='member'><a href="module-io.html#.POLLPRI">POLLPRI</a></li><li data-type='member'><a href="module-io.html#.POLLRDBAND">POLLRDBAND</a></li><li data-type='member'><a href="module-io.html#.POLLRDHUP">POLLRDHUP</a></li><li data-type='member'><a href="module-io.html#.POLLRDNORM">POLLRDNORM</a></li><li data-type='member'><a href="module-io.html#.POLLREMOVE">POLLREMOVE</a></li><li data-type='member'><a href="module-io.html#.POLLWRBAND">POLLWRBAND</a></li><li data-type='member'><a href="module-io.html#.POLLWRNORM">POLLWRNORM</a></li><li data-type='member'><a href="module-io.html#.SEEK_CUR">SEEK_CUR</a></li><li data-type='member'><a href="module-io.html#.SEEK_END">SEEK_END</a></li><li data-type='member'><a href="module-io.html#.SEEK_SET">SEEK_SET</a></li></ul><ul class='methods'><li data-type='method'><a href="module-io.html#.append">append</a></li><li data-type='method'><a href="module-io.html#.close">close</a></li><li data-type='method'><a href="module-io.html#.create">create</a></li><li data-type='method'><a href="module-io.html#.dup">dup</a></li><li data-type='method'><a href="module-io.html#.dup2">dup2</a></li><li data-type='method'><a href="module-io.html#.open">open</a></li><li data-type='method'><a href="module-io.html#.pipe">pipe</a></li><li data-type='method'><a href="module-io.html#.poll">poll</a></li><li data-type='method'><a href="module-io.html#.read">read</a></li><li data-type='method'><a href="module-io.html#.read_fully">read_fully</a></li><li data-type='method'><a href="module-io.html#.read_string">read_string</a></li><li data-type='method'><a href="module-io.html#.seek">seek</a></li><li data-type='method'><a href="module-io.html#.tell">tell</a></li><li data-type='method'><a href="module-io.html#.truncate">truncate</a></li><li data-type='method'><a href="module-io.html#.write">write</a></li><li data-type='method'><a href="module-io.html#.write_string">write_string</a></li></ul></li><li><a href="module-kern.html">kern</a><ul class='members'><li data-type='member'><a href="module-kern.html#.printk">printk</a></li><li data-type='member'><a href="module-kern.html#.search_path">search_path</a></li><li data-type='member'><a href="module-kern.html#.version">version</a></li></ul></li><li><a href="module-math.html">math</a><ul class='methods'><li data-type='method'><a href="module-math.html#.get_random_bytes">get_random_bytes</a></li></ul></li><li><a href="module-perf.html">perf</a><ul class='methods'><li data-type='method'><a href="module-perf.html#.start">start</a></li></ul></li><li><a href="module-proc.html">proc</a><ul class='members'><li data-type='member'><a href="module-proc.html#.SIGABRT">SIGABRT</a></li><li data-type='member'><a href="module-proc.html#.SIGALRM">SIGALRM</a></li><li data-type='member'><a href="module-proc.html#.SIGBUS">SIGBUS</a></li><li data-type='member'><a href="module-proc.html#.SIGCHLD">SIGCHLD</a></li><li data-type='member'><a href="module-proc.html#.SIGCONT">SIGCONT</a></li><li data-type='member'><a href="module-proc.html#.SIGFPE">SIGFPE</a></li><li data-type='member'><a href="module-proc.html#.SIGHUP">SIGHUP</a></li><li data-type='member'><a href="module-proc.html#.SIGILL">SIGILL</a></li><li data-type='member'><a href="module-proc.html#.SIGINT">SIGINT</a></li><li data-type='member'><a href="module-proc.html#.SIGIO">SIGIO</a></li><li data-type='member'><a href="module-proc.html#.SIGIOT">SIGIOT</a></li><li data-type='member'><a href="module-proc.html#.SIGKILL">SIGKILL</a></li><li data-type='member'><a href="module-proc.html#.SIGPIPE">SIGPIPE</a></li><li data-type='member'><a href="module-proc.html#.SIGPOLL">SIGPOLL</a></li><li data-type='member'><a href="module-proc.html#.SIGPROF">SIGPROF</a></li><li data-type='member'><a href="module-proc.html#.SIGPWR">SIGPWR</a></li><li data-type='member'><a href="module-proc.html#.SIGQUIT">SIGQUIT</a></li><li data-type='member'><a href="module-proc.html#.SIGSEGV">SIGSEGV</a></li><li data-type='member'><a href="module-proc.html#.SIGSTKFLT">SIGSTKFLT</a></li><li data-type='member'><a href="module-proc.html#.SIGSTOP">SIGSTOP</a></li><li data-type='member'><a href="module-proc.html#.SIGSYS">SIGSYS</a></li><li data-type='member'><a href="module-proc.html#.SIGTERM">SIGTERM</a></li><li data-type='member'><a href="module-proc.html#.SIGTRAP">SIGTRAP</a></li><li data-type='member'><a href="module-proc.html#.SIGTSTP">SIGTSTP</a></li><li data-type='member'><a href="module-proc.html#.SIGTTIN">SIGTTIN</a></li><li data-type='member'><a href="module-proc.html#.SIGTTOU">SIGTTOU</a></li><li data-type='member'><a href="module-proc.html#.SIGUNUSED">SIGUNUSED</a></li><li data-type='member'><a href="module-proc.html#.SIGURG">SIGURG</a></li><li data-type='member'><a href="module-proc.html#.SIGUSR1">SIGUSR1</a></li><li data-type='member'><a href="module-proc.html#.SIGUSR2">SIGUSR2</a></li><li data-type='member'><a href="module-proc.html#.SIGVTALRM">SIGVTALRM</a></li><li data-type='member'><a href="module-proc.html#.SIGWINCH">SIGWINCH</a></li><li data-type='member'><a href="module-proc.html#.SIGXCPU">SIGXCPU</a></li><li data-type='member'><a href="module-proc.html#.SIGXFSZ">SIGXFSZ</a></li><li data-type='member'><a href="module-proc.html#.WCONTINUED">WCONTINUED</a></li><li data-type='member'><a href="module-proc.html#.WNOHANG">WNOHANG</a></li><li data-type='member'><a href="module-proc.html#.WUNTRACED">WUNTRACED</a></li></ul><ul class='methods'><li data-type='method'><a href="module-proc.html#.alarm">alarm</a></li><li data-type='method'><a href="module-proc.html#.atexit">atexit</a></li><li data-type='method'><a href="module-proc.html#.chdir">chdir</a></li><li data-type='method'><a href="module-proc.html#.exec">exec</a></li><li data-type='method'><a href="module-proc.html#.exit">exit</a></li><li data-type='method'><a href="module-proc.html#.fork">fork</a></li><li data-type='method'><a href="module-proc.html#.fork2">fork2</a></li><li data-type='method'><a href="module-proc.html#.getegid">getegid</a></li><li data-type='method'><a href="module-proc.html#.getenv">getenv</a></li><li data-type='method'><a href="module-proc.html#.geteuid">geteuid</a></li><li data-type='method'><a href="module-proc.html#.getgid">getgid</a></li><li data-type='method'><a href="module-proc.html#.getpid">getpid</a></li><li data-type='method'><a href="module-proc.html#.getuid">getuid</a></li><li data-type='method'><a href="module-proc.html#.kill">kill</a></li><li data-type='method'><a href="module-proc.html#.setenv">setenv</a></li><li data-type='method'><a href="module-proc.html#.setsid">setsid</a></li><li data-type='method'><a href="module-proc.html#.signal">signal</a></li><li data-type='method'><a href="module-proc.html#.sleep">sleep</a></li><li data-type='method'><a href="module-proc.html#.unsetenv">unsetenv</a></li><li data-type='method'><a href="module-proc.html#.waitpid">waitpid</a></li></ul></li><li><a href="module-shell.html">shell</a><ul class='methods'><li data-type='method'><a href="module-shell.html#.$">$</a></li><li data-type='method'><a href="module-shell.html#.capture">capture</a></li><li data-type='method'><a href="module-shell.html#.file">file</a></li><li data-type='method'><a href="module-shell.html#.here">here</a></li><li data-type='method'><a href="module-shell.html#.search_path">search_path</a></li></ul></li><li><a href="module-stream.html">stream</a><ul class='methods'><li data-type='method'><a href="module-stream.html#.create">create</a></li><li data-type='method'><a href="module-stream.html#.read_line">read_line</a></li><li data-type='method'><a href="module-stream.html#.read_until">read_until</a></li></ul></li><li><a href="module-term.html">term</a><ul class='methods'><li data-type='method'><a href="module-term.html#.bg">bg</a></li><li data-type='method'><a href="module-term.html#.clear">clear</a></li><li data-type='method'><a href="module-term.html#.fg">fg</a></li><li data-type='method'><a href="module-term.html#.hide_cursor">hide_cursor</a></li><li data-type='method'><a href="module-term.html#.move_to">move_to</a></li><li data-type='method'><a href="module-term.html#.print">print</a></li><li data-type='method'><a href="module-term.html#.print2">print2</a></li><li data-type='method'><a href="module-term.html#.println">println</a></li><li data-type='method'><a href="module-term.html#.println2">println2</a></li><li data-type='method'><a href="module-term.html#.read_line">read_line</a></li><li data-type='method'><a href="module-term.html#.reset">reset</a></li><li data-type='method'><a href="module-term.html#.show_cursor">show_cursor</a></li><li data-type='method'><a href="module-term.html#.to_string">to_string</a></li></ul></li></ul><h3>Interfaces</h3><ul><li><a href="Redirection.html">Redirection</a><ul class='methods'><li data-type='method'><a href="Redirection.html#close">close</a></li><li data-type='method'><a href="Redirection.html#open">open</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#ListDirCallback">ListDirCallback</a></li><li><a href="global.html#Pollfd">Pollfd</a></li><li><a href="global.html#ProcExecOptions">ProcExecOptions</a></li><li><a href="global.html#ProcResult">ProcResult</a></li><li><a href="global.html#StatBuf">StatBuf</a></li><li><a href="global.html#SysError">SysError</a></li><li><a href="global.html#TimeSpec">TimeSpec</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">io/index.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const errno = require('errno');

const decoder = new TextDecoder();
const encoder = new TextEncoder();

/**
 * A poll() descriptor
 *
 * @typedef {object} Pollfd
 *
 * @property {number} fd File descriptor to check
 *
 * @property {number} events 
 * Events to check (the "See" section list possible values)
 *
 * @property {number} revents 
 * Returned events (the "See" section list possible values)
 *
 * @see {@link module:io.POLLIN}
 * @see {@link module:io.POLLPRI}
 * @see {@link module:io.POLLOUT}
 * @see {@link module:io.POLLERR}
 * @see {@link module:io.POLLHUP}
 * @see {@link module:io.POLLNVAL}
 * @see {@link module:io.POLLRDNORM}
 * @see {@link module:io.POLLRDBAND}
 * @see {@link module:io.POLLWRNORM}
 * @see {@link module:io.POLLWRBAND}
 * @see {@link module:io.POLLMSG}
 * @see {@link module:io.POLLREMOVE}
 * @see {@link module:io.POLLRDHUP}
 */

const LF_CODE = '\n'.charCodeAt(0);


/** 
 * @exports io 
 * @readonly
 * @enum {number}
 */
const io = {
	/* Poll flags */
	POLLIN: 0x1,
	POLLPRI: 0x2,
	POLLOUT: 0x4,
	POLLERR: 0x8,
	POLLHUP: 0x10,
	POLLNVAL: 0x20,
	POLLRDNORM: 0x40,
	POLLRDBAND: 0x80,
	POLLWRNORM: 0x100,
	POLLWRBAND: 0x200,
	POLLMSG: 0x400,
	POLLREMOVE: 0x1000,
	POLLRDHUP: 0x2000,

	/* seek flags */

	/** Seek from start of file */
	SEEK_SET: 0,
	/** Seek from current position */
	SEEK_CUR: 1,
	/** Seek from end of file */
	SEEK_END: 2,
};

const O_APPEND = 02000;
const O_CREAT = 0100;
const O_RDWR = 02;
const O_TRUNC = 01000;

/**
 * Open a file for appending. If the file does not exist it is created. If it 
 * exists its contents remain untouched.
 *
 * Note that the file pointer will always be set to EOF before any write
 * operation.
 *
 * @param {string} pathname Path to file
 *
 * @param {number} [mode=0644]
 * Access mode of file in case it needs to be created
 *
 * @returns {number} The file descriptor
 * @throws {SysError}
 * @see {module:io.create}
 * @see {module:io.open}
 * @see {module:io.truncate}
 */
io.append = function(pathname, mode) {
	mode = Number(mode || 0644);

	return j.open(pathname, O_CREAT|O_APPEND|O_RDWR, mode);
}

/**
 * Close an open file
 *
 * @param {number} fd The file descriptor
 * @param {boolean} [fail_if_closed=true] Fail if file is already closed
 * @returns {0}
 * @throws {SysError}
 */
io.close = function(fd, fail_if_closed) {
	try {
		return j.close(Number(fd));
	} 
	catch(err) {
		if (fail_if_closed || (err.errno !== errno.EBADF)) {
			throw err;
		}

		return 0;
	}
}

/**
 * Open a file. If the file does not exist it is created. If it exists its
 * contents remain untouched.
 *
 * @param {string} pathname Path to file
 *
 * @param {number} [mode=0644]
 * Access mode of file in case it needs to be created
 *
 * @returns {number} The file descriptor
 * @throws {SysError}
 * @see {module:io.append}
 * @see {module:io.open}
 * @see {module:io.truncate}
 */
io.create = function(pathname, mode) {
	mode = Number(mode || 0644);

	return j.open(pathname, O_CREAT|O_RDWR, mode);
}

/**
 * Duplicate an open file descriptor
 *
 * @param {number} fd The existing file descriptor
 * @returns {number} The new file descriptor
 * @throws {SysError}
 */
io.dup = function(fd) {
	return j.dup(Number(fd));
}

/**
 * Duplicate an open file descriptor assigning it to another custom fd
 *
 * @param {number} openFd The existing file descriptor
 * @param {number} changedFd The file descriptor that will be changed
 * @returns {number} The changed file descriptor
 * @throws {SysError}
 */
io.dup2 = function(openFd, changedFd) {
	return j.dup2(Number(openFd), Number(changedFd));
}

/**
 * Open an existing file.
 *
 * @param {string} pathname Path to file
 *
 * @returns {number} The file descriptor
 * @throws {SysError}
 * @see {module:io.append}
 * @see {module:io.create}
 * @see {module:io.truncate}
 */
io.open = function(pathname) {
	try {
		return j.open(pathname, 0, 0);
	}
	catch(err) {
		err.message += ' (' + pathname + ')';
		throw err;
	}
}

/**
 * Create a pipe
 *
 * @returns {number[]} 
 * An array with two file descriptors where `[0]` item is the read end of the
 * pipe and `[1]` is the write end.
 *
 * @throws {SysError}
 */
io.pipe = function() {
	const fildes = [-1, -1];

	return j.pipe(fildes).fildes;	
}

/**
 * The poll() function provides applications with a mechanism for multiplexing 
 * input/output over a set of file descriptors.
 *
 * For each member of the array pointed to by `fds`, poll() shall examine the 
 * given file descriptor for the event(s) specified in events.
 *
 * The poll() function shall identify those file descriptors on which an 
 * application can read or write data, or on which certain events have occurred.
 *
 * @param {Pollfd} fds File descriptors and events to check
 * @param {number} [timeout=-1] Timeout in milliseconds or -1 to wait forever
 * @returns {number} Count of fds with events or 0 on timeout
 * @throws {SysError}
 */
io.poll = function(fds, timeout) {
	if (timeout === undefined) {
		timeout = -1;
	}

	timeout = Number(timeout);

	const result = j.poll(fds, fds.length, timeout);

	fds.length = 0;
	for (var i=0; i&lt;result.fds.length; i++) {
		fds.push(result.fds[i]);
	}

	return result.value;
}

/**
 * Read bytes from an open file
 *
 * @param {number} fd An open file desriptor
 * @param {Uint8Array} buf Buffer to fill with read bytes
 *
 * @param {number} [count=-1] 
 * Maximum number of bytes to read, or `-1` to read until buffer is full or EOF.
 *
 * Note that it is not the same `-1` as `buf.length`, because `buf.length` does
 * not guarantee that the whole buffer is read.
 *
 * @returns {number} 
 * The number of bytes read (with 0 meaning end of file).
 *
 * In the case where `count = -1`, a return less than buffer length means that
 * EOF was reached.
 *
 * @throws {SysError}
 */
io.read = function(fd, buf, count) {
	if (count === undefined) {
		count = -1;
	}

	fd = Number(fd);
	count = Number(count);

	if (count === -1) {
		count = buf.length;

		const bleft = buf.length;

		while (true) {
			const bread = j.read(fd, buf, bleft);

			if (bread === 0) {
				break;
			}

			bleft -= bread;

			if (bleft === 0) {
				break;
			}

			buf = new Uint8Array(buf, bread);
		}

		return count - bleft;
	} 
	else {
		return j.read(fd, buf, count);
	}
}

/**
 * Read contents of a fd until it is exhausted and return them as an Uint8Array.
 *
 * @param {number} fd An open file desriptor
 * @returns {Uint8Array} The bytes contained by the file
 * @throws {SysError}
 */
io.read_fully = function(fd) {
	const buf = new Uint8Array(4096);

	var bytes = new Uint8Array(buf.length);
	var count = 0;

	while (true) {
		const bread = io.read(fd, buf);

		if (bytes.length &lt; (count + bread)) {
			const new_bytes =
				(count > 0x100000) 
					? new Uint8Array(count + 0x100000)
					: new Uint8Array(count * 2);

			new_bytes.set(bytes);

			bytes = new_bytes;
		}

		bytes.set(buf, count);

		count += bread;

		if (bread &lt; buf.length) {
			break;
		}
	}

	if (bytes.length !== count) {
		const new_bytes = new Uint8Array(count);

		new_bytes.set(bytes.subarray(0, count));

		bytes = new_bytes;
	}

	return bytes;
}

/**
 * Read contents of a fd until it is exhausted and return them as a string. 
 *
 * The bytes are interpreted as UTF-8.
 *
 * @param {number} fd An open file desriptor
 * @returns {string} The contents of the file interpreted as an UTF-8 string
 * @throws {SysError}
 */
io.read_string = function(fd) {
	return decoder.decode(io.read_fully(fd));
}

/**
 * Set the pointer of a file descriptor to a given value
 *
 * @param {number} fd An open file descriptor
 * @param {number} offset Relative offset for file pointer
 *
 * @param {number} whence
 * Base of offset. One of the values: {@link module:io.SEEK_SET}, 
 * {@link module:io.SEEK_CUR}, or {@link module:io.SEEK_END}.
 *
 * @returns {number} The resulting offset measured from start of file
 * @throws {SysError}
 */
io.seek = function(fd, offset, whence) {
	return j.lseek(fd, offset, whence);
}

/**
 * Retrieve the current offset of the file pointer from the start of the file.
 *
 * @param {number} fd An open file desriptor
 * @returns {number} The offset of the file pointer
 * @throws {SysError}
 */
io.tell = function(fd) {
	return io.seek(fd, 0, io.SEEK_CUR);
}

/**
 * Open a file and empty it. If the file does not exist it is created.
 *
 * @param {string} pathname Path to file
 *
 * @param {number} [mode=0644]
 * Access mode of file in case it needs to be created
 *
 * @returns {number} The file descriptor
 * @throws {SysError}
 * @see {module:io.append}
 * @see {module:io.create}
 * @see {module:io.open}
 */
io.truncate = function(pathname, mode) {
	mode = mode || 0644;

	return j.open(pathname, O_CREAT|O_TRUNC|O_RDWR, Number(mode));
}

/**
 * Write bytes to an open file
 *
 * @param {number} fd An open file desriptor
 * @param {Uint8Array} buf Buffer containing bytes to write
 *
 * @param {number} [count=-1] 
 * Maximum number of bytes to write or -1 to keep writing until all buffer has 
 * been written. 
 *
 * Note that it is not the same `-1` as `buf.length`, because `buf.length` does
 * not guarantee that the whole buffer is written.
 *
 * @returns {number} The number of bytes written
 * @throws {SysError}
 */
io.write = function(fd, buf, count) {
	if (count === undefined) {
		count = -1;
	}

	fd = Number(fd)
	count = Number(count);

	if (count === -1) {
		count = buf.length;

		var bleft = buf.length;

		while (true) {
			const bwritten = j.write(fd, buf, bleft);

			bleft -= bwritten;

			if (bleft === 0) {
				break;
			}

			buf = new Uint8Array(buf, bwritten);
		}

		return count;
	} 
	else {
		return j.write(fd, buf, count);
	}
}

/**
 * Write a string as UTF-8 bytes to an open file
 *
 * @param {number} fd An open file desriptor
 * @param {string} str The string to write
 * @returns {number} The number of bytes written
 * @throws {SysError}
 */
io.write_string = function(fd, str) {
	fd = Number(fd);
	str = str.toString();

	return io.write(fd, encoder.encode(str.toString()));
}

return io;
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.6</a> on Mon Mar 22 2021 20:13:40 GMT+0100 (GMT+01:00) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>



</body>
</html>
